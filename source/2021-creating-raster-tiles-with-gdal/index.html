---
layout: slides-reveal
title: DIY Raster Tiles with QGIS & GDAL
theme: stark
markdown: true
date: 2021-05-11
tags: slides
transition: fade
css: >-
  h1 {
    text-align: inherit;
  }
  .reveal .slides {
    max-height: calc(100% - 6rem);
    overflow: hidden;
  }

  *, .reveal {
    font-family: "Inconsolata", monospace;
  }
  
  .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
    font-family: "Inconsolata", monospace;
    font-weight: 600;
  }

  code, table {
    font-size: smaller;
  }

  .reveal blockquote {
    background: hsl(349deg 86% 95%);
    border-radius: 5px;
    padding: 2rem;
  }

  .reveal blockquote, strong, .controls-arrow, em {
    color: crimson;
  }

center: false
highlight: xcode.css
---

# DIY Raster Tiles with QGIS & GDAL

---

## FYI

> This talk is not about Machine Learning or AI or any fancy new technology.

---

## Rasters & Raster Tiles

> High Resolution Orthoimagery is one of the foundations of a Modern GIS.

---

## Goal

> Use open source tools to generate web map tiles from an orthomosaic.

---

### Prerequisites

*For those wanting to follow along.*

- Have QGIS 3.x installed and working
- Have gdal installed and working
  - ``gdal-info --version``
- Obtain a copy of the sample rasters

---

### Note on Projections

**NAD83 HARN <> NAD83 <> WGS84**

EPSG.io

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs 
  </code>
</pre>

SpatialReference.org

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs
  </code>
</pre>

---

## Null Transformation

#### +datum=NAD83

#### +towgs84=0,0,0,0,0,0,0

---

## Esri ITRF00 

---
## Why

- You don't want to tie up your production machine for a week tiling raster data 
- You want to learn more about how web maps work
- You don't have access to commercial software for publishing raster tiles to the web
- You want to plan a mission to Mars

---

## Deployment

> Since the end product is just a folder tree, the raster tiles can be deployed on any static web host or CDN.

---

### Local Deployment

- 1 County Raster Tiles ~ 100 GB - 1 TB
- 10 TB HDD ~ $250

### Cloud Storage 

- Amazon S3, Digital Ocean Spaces...
- keycdn, Netlify (for small projects)

---

## Carta do Mundo de Mercator (1569)

> The world is (not) flat.

![alt=mercator-map](1024px-Mercator_1569.png)

[Wikipedia Link](https://en.wikipedia.org/wiki/Mercator_1569_world_map#/media/File:Mercator_1569.png)
---

### Legend 3

> "Firstly, to spread on a plane the surface of the sphere in such a way that the positions of places shall correspond on all sides with each other, both in so far as true direction and distance are concerned and as correct longitudes and latitudes..."

> "...the limitations of ancient geography be not unknown and that the honour which is due to past centuries be given to them." 

~ Gerardus Mercator, 1569

---

## Mercator Distortions

![alt=map showing true size of continents](mercator-true-size.png)

[True Size](https://thetruesize.com/)

---

## "Slippy" Web Map Basics

- Started with Google, now standardized
- Made up of 256x256 raster or vector tiles
- World Tile Coverage = 2^2z

![](zoom-levels.png)

Local Tiles = # @ Next Zoom Level ~ # at Prev Zoom * 4 

---

## Mars Mission Planning

![alt=Mars Mission Planning](mmgis-snapshot.png)

[Mars Rover Location Map](https://mars.nasa.gov/maps/)

---

## Overview

- Look at our sample rasters
- Inspect the rasters with gdalinfo

> Remember to transform your data or be willing to live with the results

- Run the gdal2tiles tool
- Images do not need to be georeferenced

---



256x256 

or

512x512

for high res screens (twice the amount of pixels in the same amount of space)

---

gdal-info

XYZ map tiles what are they brief explanation

![](/images/zoom-levels.png)

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles * 2
Optionally convert the directory of png image tiles to the webp format.



---

//TODO turn this into notes?
The most recent orthomosaics from OGRIP are in the NAD83 HARN projection. The default GDAL projection to WGS84 is null, so keep this in mind, especially if you want to maintian high accuracy for the web map tiles. For most of the examples below, Esri tools were used to transform the data from NAD83 HARN Ohio to Web Mercator, due to not being able to replicate the NAD83 to HARN Ohio Esri transformation using open source tools.

*A custom `proj` string can be used go from NAD83 to WGS84, ([getbounds.com/blog/rtk-to-wgs84/](https://www.getbounds.com/blog/rtk-to-wgs84/)).

---

### Pre-processing

**Raw TIFF Files (ArcGIS Pro)**

1. Created a Mosaic of TIFF files
2. Projected Raster to EPSG:3735 LZW TIFF
3. Projected Raster to EPSG:3857 JPG YCbCR TIFF

**OGRIP MrSID Files (QGIS)**

1. Copy Raster to EPSG:3857 JPG YCbCR
  - (NULL Transformation)

---


### Overview

- Overview of raster tiles
- Discussion of **Why?**
- Create tiles with GDAL
- Running in **Production?**
- Introduction to mbtiles
- Create mbtiles with QGIS
- Serve with mbtileserver
 - pre-built windows exe file

---

### The world is (not) a square.

![zoom-levels](zoom-levels.png)

256x256 or 512x512 pixels

---

### Why not Commerical (Satellite) Imagery?

- No control over Projections/Transformations
- Commercial Imagery is Outdated
- Cannot be supplemented with UAV Mosaics
- Low Resolution [(15cm Sat Coming Soon!)](https://www.geospatialworld.net/news/radar-satellite-startup-umbra-plans-to-capture-imagery-with-15-cm-resolution/)

---

### Bing Maps (~2016)

![](img/medcenter-bing.png)

---

### Google Maps (~2018)

![](img/medcenter-google.png)

---

### Esri/Mapbox (Maxar ~2019)

![](img/medcenter-mapbox.png)

---

### Local 2020 Aerial

![](img/medcenter-local.png)

---

### Additional Benefits

- Supplement the tiles with newer imagery
- Any image can be tiled, not just ortho imagery
- Raw Tiles can be hosted anywhere
- Tools are free and open source

---

### Warning

> Live Coding Ahead!!

---

### Let's Explore Some Data

<pre><code data-trim data-noescape data-python>gdalinfo Franklin_rgb_100x.sid
</code></pre>

---

### Key Components

- NODATA Value
- Projection
- Compression
- Pyramids

---

### Raster Tiling Tools

- ArcGIS Image Cache
- QGIS Generate xyz tiles (mbtiles)
- gdal2tiles

---

### Hosting Options

- ArcGIS Image Cache 
  - ArcGIS Server/AGOL
- mbtiles file
  - mbtileserver
- XYZ Folder Tree
  - **Any web host**

---


### One Countywide Aerial (z21)

|Source|Files|Format|Size|
|-|-:|-|-:|
|Raw Tiff|39,985|TIFF|1150 GB|
|Orthomosaic|2|TIFF/JPG|62 GB|
|ArcGIS Cache|1,316|PNG,JPG|101 GB|
|Raster Tiles|11,511,665|PNG|851 GB|
|Raster Tiles|11,511,665|**WEBP**|200 GB|
|mbtiles|1|SQLITE|1150 GB|

---

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles x 2
Optionally convert the directory of png image tiles to the webp format.

---

## Get the Data

---

transparency

---

web preview

---

multi-threaded

---

output format

- png
- jpg
- webp

---

QGIS Built-in Converter


Load the raster into QGIS
Change the zoomed in sampling to Average and any other settings under properties
Export to raster tiles using the processing tool Generate XYZ Tiles

---

Use the latest gdal2tiles.py python script downloaded from the gdal GitHub site to cut the tif into a folder of high resolution raster tiles for use in web mapping. There are similar scripts that will output to mbtiles, output to geopackage, or write to JPG files. This script was originally written by the developer of MapTiler. The default for this updated script is to use all the availabel cpu cores, so be careful when running it. Set the --processes to something you can live with, such as half the available cores. A maximum zoom limit of 20 seems to be a good limit, which is about street level, however if you want to use them in AGOL you will need to go to zoom 21 as AGOL does not overzoom tiles.

---

```Python
python.exe gdal2tiles.py -xyz -v sourceFile.tif outputFolder
```

```Python
python gdal2tiles.py -e -z 0-21 -v --xyz --processes=ALL original_tiff_file destination_directory
```

```
--tilesize=512
```

## Hosting your Tiles

- https://github.com/maptiler/tileserver-php
- https://github.com/consbio/mbtileserver

---

#### References

- https://blog.mastermaps.com/2008/03/generating-map-tiles-with-gdal2tiles.html
- http://build-failed.blogspot.com/2012/11/zoomable-image-with-leaflet.html
- https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/
- https://wiki.openstreetmap.org/wiki/TMS
- https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/
- https://github.com/ecometrica/gdal2mbtiles
- http://emapr.ceoas.oregonstate.edu/pages/education/how_to/how_to_tws.html
- https://developers.google.com/kml/articles/raster