---
layout: slides-reveal
title: Raster Tiles with QGIS & GDAL
theme: therepublic
markdown: true
date: 2021-05-11
tags: slides
transition: none
css: >-
  .reveal .slide-background {
    background-color: #121212;

  }
  h1 {
    text-align: inherit;
  }
  .reveal .slides {
    color: #fff;
    max-height: calc(100% - 6rem);
    overflow: hidden;
    text-align: left;
  }

  *, .reveal {
    font-family: "Inconsolata", monospace;
  }
  
  .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
    color: #fff;
    font-family: "Kanit", monospace;
    font-weight: 600;
    text-transform: none
  }

  .reveal code, .reveal table {
    font-size: smaller;
    margin: 0;
  }

  .reveal blockquote {
    font-family: "Galaxy";
  /*background: hsl(349deg 86% 95%);*/
    border-radius: 5px;
    padding: 2rem;
    text-align: center;
    font-style: normal;
    font-size: 1.5em;

  }

  .reveal blockquote, .controls-arrow {
    color: crimson;
    color: #FFF92F
  }

  .reveal em {
    color: #FFF92F;
    font-style: normal
  }

  .reveal strong {
    color: crimson;
  }
  /*red - rgb(187,36,50)
  blue/[urple - rgb(35,34,131)
  light blue - rgb(212,224,248)
  darkgreen - rgb(14,75,42)
  yellow - FFF92F*/

  .reveal section img, .reveal video, .reveal iframe {
    margin: 0 auto;
    max-width: 85%;
    max-height: 85%;
    text-align: center;
  }
  .reveal code:not(.hljs) {
    color: #121212;
    filter: invert(1);
  }
  .reveal pre {
    width: 100%;
  }
center: false
highlight: monokai.css
---

## DIY Raster Tiles with QGIS & GDAL

*Using open source tools to generate web map tiles from an orthomosaic.*

<br>
Malcolm Meyer

Ohio GIS Conference 2021

---

## *High Resolution Orthoimagery is one of the foundations of a Modern GIS.*

---

### Why not Commerical *(Satellite)* Imagery?

- No control over Projections/Transformations
- Commercial Imagery is Outdated
- Cannot be supplemented with UAV Mosaics
- Low Resolution [(15cm Sat Coming Soon!)](https://www.geospatialworld.net/news/radar-satellite-startup-umbra-plans-to-capture-imagery-with-15-cm-resolution/)

---

### Bing Maps (~2016)

![](img/medcenter-bing.png)

---

### Google Maps (~2018)

![](img/medcenter-google.png)

---

### Esri/Mapbox (Maxar ~2019)

![](img/medcenter-mapbox.png)

---

### *Local 2020 Aerial*

![](img/medcenter-local.png)

---

## Why *DIY* Tiles

- You don't want to tie up your production machine for a week tiling raster data 
- You want to learn more about how web maps work
- You don't have access to commercial software for publishing raster tiles to the web
- Your can't use external web services due to security, firewalls, etc.
- You want to plan a mission to Mars

---

## Even More Reasons

![arcgis cache error](img/cache_error.png)

---

## Simple Deployment

### *The output can be deployed on any static web host or CDN**

<br>

*In some instances it will be advantageous to use a single mbtiles file (sqlite db) instead of a directory of tiles.

---

## Tools are *Open Source*

[![alt=image of mars](img/mmgis-snapshot.png)](https://mars.nasa.gov/maps/)

---

## Raster Tile Basics

*Maps are usually in Web Mercator EPSG:3857*

![](img/zoom-levels.png)

Each zoom level is a directory, each column is a subdirectory, and each tile is a file.

---

#### Carta do Mundo de Mercator (1569)

[![alt=Carta do Mundo de Mercator 1569](img/1024px-Mercator_1569.png)]((https://en.wikipedia.org/wiki/Mercator_1569_world_map#/media/File:Mercator_1569.png))

---

## The 'Mercator' Projection

*Firstly, to spread on a plane the surface of the sphere in such a way that the positions of places shall correspond on all sides with each other, both in so far as true direction and distance are concerned and as correct longitudes and latitudes...*

---

## On Cartography

*...the limitations of ancient geography be not unknown and that the honour which is due to past centuries be given to them.*

~ Gerardus Mercator, 1569

---

## Mercator Distortions

![alt=map showing true size of continents](img/mercator-true-size.png)

[True Size](https://thetruesize.com/)

---

### Note on Transformations

*NAD83 HARN < > NAD83 < > WGS84*

EPSG.io ([skip ahead](./#/18))

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs 
  </code>
</pre>

SpatialReference.org

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs
  </code>
</pre>

---

## Raster Tiling Tools

- ArcGIS Image Cache
- gdal2tiles
- QGIS Generate xyz tiles (mbtiles)

---

## Hosting Options

- ArcGIS Image Cache 
  - ArcGIS Server/AGOL
- XYZ Folder Tree
  - **Any web host**
- mbtiles file
  - mbtileserver, many others

---

### A Note on File Size (z21)

|Source|Files|Format|Size|
|-|-:|-|-:|
|Raw Tiff|39,985|TIFF|1150 GB|
|Orthomosaic|2|TIFF/JPG|62 GB|
|ArcGIS Cache|1,316|PNG,JPG|101 GB|
|Raster Tiles|11,511,665|PNG|851 GB|
|Raster Tiles|11,511,665|**WEBP**|200 GB|
|Raster Tiles|11,511,665|JPG|120 GB|
|mbtiles|1|SQLITE/JPG|115 GB|

---

# BREAK

---

## Let's Get <strong>Coding</strong>

*For those wanting to follow along.*

- Have QGIS 3.x installed and working
- Have gdal installed and working
  - Open OSGeo4W Shell
  - Type ``gdalinfo --version``
  - Return ~ ``GDAL 3.1.4, released 2020/10/20``
- Obtain a copy of the sample rasters

---

## The Process

1.Explore raster metadata with gdalinfo.

2.Verify the accuracy of the data in QGIS with GPS ground truth data.

3.Virtually transform the raster with gdalwarp.

4.Examine the output in QGIS.

5.Run gdal2tiles and test the output.

6.Run Generate XYZ Tiles (mbtiles) in QGIS.

7.Serve mbtiles file with mbtileserver.

---

gdal-info

XYZ map tiles what are they brief explanation

![](/images/zoom-levels.png)

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles * 2
Optionally convert the directory of png image tiles to the webp format.

---

## *Null Transformation*

<pre>
  <code>
    +datum=NAD83 | +towgs84=0,0,0,0,0,0,0
  </code>
</pre>

#### **Esri ITRF00 (Default NAD83 <> WGS84)**

<pre>
  <code>
    0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062
  </code>
</pre>

[proj definitions](#/12)
---

## Proj4 String

Replacement for the default NAD83 projection definition in GDAL.

<pre>
  <code>
    +proj=lcc +lat_0=38 +lon_0=-82.5 +lat_1=40.0333333333333 +lat_2=38.73333333333 \
    +x_0=600000 +y_0=0 +ellps=GRS80 \
    +towgs84=-0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062 \
    +units=us-ft +no_defs
  </code>
</pre>

---

run gdalwarp project into 3857 - this results into a more crisp image compared to transforming into 4326, not sure Why

``` bash

gdalwarp -t_srs EPSG:3857 -s_srs "+proj=lcc +lat_0=38 +lon_0=-82.5 +lat_1=40.0333333333333 +lat_2=38.7333333333333 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=-0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062 +units=us-ft +no_defs" -r average -multi -srcnodata 255 -of VRT g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid g:\data\imagery\fairfield\2020\2020_fairfield_3in_3857.vrt

```

.vrt is a supported Raster format type for Esri applications. See https://pro.arcgis.com/en/pro-app/latest/help/data/imagery/supported-raster-dataset-file-formats.htm

*This resulting virtual raster can be used directly in ArcGIS Pro to create a Map Server Tile Cache instead of having to first export the original raster into WGS84 or Web Mercator.*

---

//TODO turn this into notes?
The most recent orthomosaics from OGRIP are in the NAD83 HARN projection. The default GDAL projection to WGS84 is null, so keep this in mind, especially if you want to maintian high accuracy for the web map tiles. For most of the examples below, Esri tools were used to transform the data from NAD83 HARN Ohio to Web Mercator, due to not being able to replicate the NAD83 to HARN Ohio Esri transformation using open source tools.

*A custom `proj` string can be used go from NAD83 to WGS84, ([getbounds.com/blog/rtk-to-wgs84/](https://www.getbounds.com/blog/rtk-to-wgs84/)).

---

### Pre-processing

**Raw TIFF Files (ArcGIS Pro)**

1. Created a Mosaic of TIFF files
2. Projected Raster to EPSG:3735 LZW TIFF
3. Projected Raster to EPSG:3857 JPG YCbCR TIFF

**OGRIP MrSID Files (QGIS)**

1. Copy Raster to EPSG:3857 JPG YCbCR
  - (NULL Transformation)

---

### mbtileserver

- Serve with mbtileserver
 - pre-built windows exe file

---

### Let's Explore Some Data

<pre><code data-trim data-noescape data-python>gdalinfo Franklin_rgb_100x.sid
</code></pre>

---

### Key Components

- NODATA Value
- Projection
- Compression
- Pyramids

---

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles x 2
Optionally convert the directory of png image tiles to the webp format.

---

## Get the Data

---

transparency

---

web preview

---

multi-threaded

---

output format

- png
- jpg
- webp

---

QGIS Built-in Converter


Load the raster into QGIS
Change the zoomed in sampling to Average and any other settings under properties
Export to raster tiles using the processing tool Generate XYZ Tiles

---

Use the latest gdal2tiles.py python script downloaded from the gdal GitHub site to cut the tif into a folder of high resolution raster tiles for use in web mapping. There are similar scripts that will output to mbtiles, output to geopackage, or write to JPG files. This script was originally written by the developer of MapTiler. The default for this updated script is to use all the availabel cpu cores, so be careful when running it. Set the --processes to something you can live with, such as half the available cores. A maximum zoom limit of 20 seems to be a good limit, which is about street level, however if you want to use them in AGOL you will need to go to zoom 21 as AGOL does not overzoom tiles.

---

```Python
python.exe gdal2tiles.py -xyz -v sourceFile.tif outputFolder
```

```Python
python gdal2tiles.py -e -z 0-21 -v --xyz --processes=ALL original_tiff_file destination_directory
```

```
--tilesize=512
```

## Hosting your Tiles

- https://github.com/maptiler/tileserver-php
- https://github.com/consbio/mbtileserver

---

### Merging & Updating mbtiles

Using DB Browser (SQLite), run the following SQL command with the destination mbtiles file open.

<pre><code>PRAGMA journal_mode=PERSIST;
PRAGMA page_size=80000;
PRAGMA synchronous=OFF;
ATTACH DATABASE 'c:/path/to/updated_file.mbtiles' AS source;
REPLACE INTO tiles SELECT * FROM source.tiles;
</code></pre>

---

```
gdalinfo raster.tif
```
gdalsrsinfo -o proj4 g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid
gdalinfo g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid

[https://gdal.org/programs/gdalsrsinfo.html](https://gdal.org/programs/gdalsrsinfo.html)
[https://gdal.org/programs/gdalinfo.html](https://gdal.org/programs/gdalinfo.html)
---


#### References

- https://www.researchgate.net/publication/321064657_Web_mercator_and_raster_tile_maps_two_cornerstones_of_online_map_service_providers
- https://blog.mastermaps.com/2008/03/generating-map-tiles-with-gdal2tiles.html
- http://build-failed.blogspot.com/2012/11/zoomable-image-with-leaflet.html
- https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/
- https://wiki.openstreetmap.org/wiki/TMS
- https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/
- https://github.com/ecometrica/gdal2mbtiles
- http://emapr.ceoas.oregonstate.edu/pages/education/how_to/how_to_tws.html
- https://developers.google.com/kml/articles/raster
- http://www.perrygeo.com/lazy-raster-processing-with-gdal-vrts.html
- https://jeromegagnonvoyer.wordpress.com/2015/08/06/merging-multiple-mbtiles-together/