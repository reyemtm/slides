---
layout: slides-reveal
title: DIY Raster Tiles with QGIS & GDAL
theme: stark
markdown: true
date: 2021-05-11
tags: slides
transition: fade
css: >-
  h1 {
    text-align: inherit;
  }
  .reveal .slides {
    max-height: calc(100% - 6rem);
    overflow: hidden;
  }

  *, .reveal {
    font-family: "Inconsolata", monospace;
  }
  
  .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
    font-family: "Inconsolata", monospace;
    font-weight: 600;
  }

  code, table {
    font-size: smaller;
  }

  .reveal blockquote {
    background: hsl(349deg 86% 95%);
    border-radius: 5px;
    padding: 2rem;
  }

  .reveal blockquote, strong, .controls-arrow, em {
    color: crimson;
  }

center: false
highlight: xcode.css
---

# DIY Raster Tiles with QGIS & GDAL

---

## Goal

> Use open source tools to generate web map tiles from an orthomosaic.

---

### Prerequisites

*For those wanting to follow along.*

- Have QGIS 3.x installed and working
- Have gdal installed and working
  - ``gdal-info --version``
- Obtain a copy of the sample rasters

---

### Note on Projections

> Esri tools may need to be used to transform the data from NAD83 HARN (OGRIP Imagery) to Web Mercator using a high accuracy transformation.*

*A custom `proj` string could be used as well, ([getbounds.com/blog/rtk-to-wgs84/](https://www.getbounds.com/blog/rtk-to-wgs84/)).

---

### Pre-processing

**Raw TIFF Files (ArcGIS Pro)**

1. Created a Mosaic of TIFF files
2. Projected Raster to EPSG:3735 LZW TIFF
3. Projected Raster to EPSG:3857 JPG YCbCR TIFF

**OGRIP MrSID Files (QGIS)**

1. Copy Raster to EPSG:3857 JPG YCbCR
  - (NULL Transformation)

---


### Overview

- Overview of raster tiles
- Discussion of **Why?**
- Create tiles with GDAL
- Running in **Production?**
- Introduction to mbtiles
- Create mbtiles with QGIS
- Serve with mbtileserver
 - pre-built windows exe file

---

### The world is (not) a square.

![zoom-levels](zoom-levels.png)

256x256 or 512x512 pixels

---

### Why not Commerical (Satellite) Imagery?

- No control over Projections/Transformations
- Commercial Imagery is Outdated
- Cannot be supplemented with UAV Mosaics
- Low Resolution [(15cm Sat Coming Soon!)](https://www.geospatialworld.net/news/radar-satellite-startup-umbra-plans-to-capture-imagery-with-15-cm-resolution/)

---

### Bing Maps (~2016)

![](medcenter-bing.png)

---

### Google Maps (~2018)

![](medcenter-google.png)

---

### Esri/Mapbox (Maxar ~2019)

![](medcenter-mapbox.png)

---

### Local 2020 Aerial

![](medcenter-local.png)

---

### Additional Benefits

- Supplement the tiles with newer imagery
- Any image can be tiled, not just ortho imagery
- Raw Tiles can be hosted anywhere
- Tools are free and open source

---

### Warning

> Live Coding Ahead!!

---

### Let's Explore Some Data

<pre><code data-trim data-noescape data-python>gdalinfo Franklin_rgb_100x.sid
</code></pre>

---

### Key Components

- NODATA Value
- Projection
- Compression
- Pyramids

---

### Raster Tiling Tools

- ArcGIS Image Cache
- QGIS Generate xyz tiles (mbtiles)
- gdal2tiles

---

### Hosting Options

- ArcGIS Image Cache 
  - ArcGIS Server/AGOL
- mbtiles file
  - mbtileserver
- XYZ Folder Tree
  - **Any web host**

---


### One Countywide Aerial (z21)

|Source|Files|Format|Size|
|-|-:|-|-:|
|Raw Tiff|39,985|TIFF|1150 GB|
|Orthomosaic|2|TIFF/JPG|62 GB|
|ArcGIS Cache|1,316|PNG,JPG|101 GB|
|Raster Tiles|11,511,665|PNG|851 GB|
|Raster Tiles|11,511,665|**WEBP**|200 GB|
|mbtiles|1|SQLITE|1150 GB|

---

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles x 2
Optionally convert the directory of png image tiles to the webp format.

---

## Get the Data

---

transparency

---

web preview

---

multi-threaded

---

output format

- png
- jpg
- webp

---

QGIS Built-in Converter


Load the raster into QGIS
Change the zoomed in sampling to Average and any other settings under properties
Export to raster tiles using the processing tool Generate XYZ Tiles

---

Use the latest gdal2tiles.py python script downloaded from the gdal GitHub site to cut the tif into a folder of high resolution raster tiles for use in web mapping. There are similar scripts that will output to mbtiles, output to geopackage, or write to JPG files. This script was originally written by the developer of MapTiler. The default for this updated script is to use all the availabel cpu cores, so be careful when running it. Set the --processes to something you can live with, such as half the available cores. A maximum zoom limit of 20 seems to be a good limit, which is about street level, however if you want to use them in AGOL you will need to go to zoom 21 as AGOL does not overzoom tiles.

---

```Python
python.exe gdal2tiles.py -xyz -v sourceFile.tif outputFolder
```

```Python
python gdal2tiles.py -e -z 0-21 -v --xyz --processes=ALL original_tiff_file destination_directory
```

```
--tilesize=512
```

## Hosting your Tiles

- https://github.com/maptiler/tileserver-php
- https://github.com/consbio/mbtileserver

---

#### References

- https://blog.mastermaps.com/2008/03/generating-map-tiles-with-gdal2tiles.html
- http://build-failed.blogspot.com/2012/11/zoomable-image-with-leaflet.html
- https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/
- https://wiki.openstreetmap.org/wiki/TMS
- https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/
- https://github.com/ecometrica/gdal2mbtiles
- http://emapr.ceoas.oregonstate.edu/pages/education/how_to/how_to_tws.html
- https://developers.google.com/kml/articles/raster