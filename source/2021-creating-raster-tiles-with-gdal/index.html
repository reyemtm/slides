---
layout: slides-reveal
title: Raster Tiles with QGIS & GDAL
theme: therepublic
markdown: true
date: 2021-05-11
tags: slides
transition: none
css: >-
  .reveal .slide-background {
    background-color: #121212;

  }
  h1 {
    text-align: inherit;
  }
  .reveal .slides {
    color: #fff;
    max-height: calc(100% - 6rem);
    overflow: hidden;
    text-align: left;
  }

  *, .reveal {
    font-family: "Inconsolata", monospace;
  }
  
  .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
    color: #fff;
    font-family: "Kanit", monospace;
    font-weight: 600;
    text-transform: none
  }

  code, table {
    font-size: smaller;
  }

  .reveal blockquote {
    font-family: "Galaxy";
  /*background: hsl(349deg 86% 95%);*/
    border-radius: 5px;
    padding: 2rem;
    text-align: center;
    font-style: normal;
    font-size: 1.5em;

  }

  .reveal blockquote, .controls-arrow {
    color: crimson;
    color: #FFF92F
  }

  .reveal em {
    color: #FFF92F;
    font-style: normal
  }

  .reveal strong {
    color: crimson;
  }
  /*red - rgb(187,36,50)
  blue/[urple - rgb(35,34,131)
  light blue - rgb(212,224,248)
  darkgreen - rgb(14,75,42)
  yellow - FFF92F*/

  .reveal section img, .reveal video, .reveal iframe {
    margin: 0 auto;
    max-width: 85%;
    max-height: 85%;
    text-align: center;
  }
  .reveal code:not(.hljs) {
    color: #121212;
    filter: invert(1);
  }
  .reveal pre {
    width: 100%;
  }
center: false
highlight: monokai.css
---

## DIY Raster Tiles with QGIS & GDAL

*Using open source tools to generate web map tiles from an orthomosaic.*

<br>
Malcolm Meyer

Ohio GIS Conference 2021

---

## *High Resolution Orthoimagery is one of the foundations of a Modern GIS.*

---

## Why

- You don't want to tie up your production machine for a week tiling raster data 
- You want to learn more about how web maps work
- You don't have access to commercial software for publishing raster tiles to the web
- Your can't use external web services due to security, firewalls, etc.
- You want to plan a mission to Mars

---

## Deployment

### *The output can be deployed on any static web host or CDN**

---

## Tools are *Open Source*

[![alt=image of mars](img/mmgis-snapshot.png)](https://mars.nasa.gov/maps/)

---

## Prerequisites

*For those wanting to follow along.*

- Have QGIS 3.x installed and working
- Have gdal installed and working
  - OSGeo4W Shell
  - ``gdalinfo --version``
  - ``GDAL 3.1.4, released 2020/10/20``
- Obtain a copy of the sample rasters

---

```
gdalinfo raster.tif
```
gdalsrsinfo -o proj4 g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid
gdalinfo g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid

[https://gdal.org/programs/gdalsrsinfo.html](https://gdal.org/programs/gdalsrsinfo.html)
[https://gdal.org/programs/gdalinfo.html](https://gdal.org/programs/gdalinfo.html)
---

### Note on Projections

*NAD83 HARN < > NAD83 < > WGS84*

EPSG.io ([skip ahead](./#/15))

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs 
  </code>
</pre>

SpatialReference.org

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs
  </code>
</pre>

---

#### Carta do Mundo de Mercator (1569)

[![alt=Carta do Mundo de Mercator 1569](img/1024px-Mercator_1569.png)]((https://en.wikipedia.org/wiki/Mercator_1569_world_map#/media/File:Mercator_1569.png))

---

## The 'Mercator' Projection

*Firstly, to spread on a plane the surface of the sphere in such a way that the positions of places shall correspond on all sides with each other, both in so far as true direction and distance are concerned and as correct longitudes and latitudes...*

---

## On Cartography

*...the limitations of ancient geography be not unknown and that the honour which is due to past centuries be given to them.*

~ Gerardus Mercator, 1569

---

## Mercator Distortions

![alt=map showing true size of continents](img/mercator-true-size.png)

[True Size](https://thetruesize.com/)

---

## "Slippy" Web Map Basics

![](img/zoom-levels.png)

- Made up of 256x256 raster or vector tiles
- Each zoom level is a directory, each column is a subdirectory, and each tile is a file

---

## *Null Transformation*

<pre>
  <code>
    +datum=NAD83 | +towgs84=0,0,0,0,0,0,0
  </code>
</pre>

#### **Esri ITRF00 (Default NAD83 <> WGS84)**

<pre>
  <code>
    0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062
  </code>
</pre>

[proj definitions](#/9)
---

## Proj4 String

Replacement for the default NAD83 projection definition in GDAL.

<pre>
  <code>
    +proj=lcc +lat_0=38 +lon_0=-82.5 +lat_1=40.0333333333333 +lat_2=38.73333333333 \
    +x_0=600000 +y_0=0 +ellps=GRS80 \
    +towgs84=-0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062 \
    +units=us-ft +no_defs
  </code>
</pre>

---

> Warning!

> Live Code Ahead!

---

## Steps

1. Transform the raster using the new proj4 string.
2. Examine the raster in QGIS.
3. Run gdal2tiles and test the output.
4. Run Generate XYZ Tiles (mbtiles) in QGIS.
5. Serve mbtiles file with mbtileserver.

---

## A Note on File Size

One Countywide Aerial (z21)

|Source|Files|Format|Size|
|-|-:|-|-:|
|Raw Tiff|39,985|TIFF|1150 GB|
|Orthomosaic|2|TIFF/JPG|62 GB|
|ArcGIS Cache|1,316|PNG,JPG|101 GB|
|Raster Tiles|11,511,665|PNG|851 GB|
|Raster Tiles|11,511,665|**WEBP**|200 GB|
|mbtiles|1|SQLITE/PNG|833 GB|
|mbtiles|1|SQLITE/JPG|200 GB|

---

- 10 TB HDD ~ $250

### Cloud Storage 

- Amazon S3, Digital Ocean Spaces...
- keycdn, Netlify (for small projects)

---

## Overview

- Look at our sample rasters
- Inspect the rasters with gdalinfo

> Remember to transform your data or be willing to live with the results

- Run the gdal2tiles tool
- Images do not need to be georeferenced

---



256x256 

or

512x512

for high res screens (twice the amount of pixels in the same amount of space)

---

gdal-info

XYZ map tiles what are they brief explanation

![](/images/zoom-levels.png)

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles * 2
Optionally convert the directory of png image tiles to the webp format.



---

//TODO turn this into notes?
The most recent orthomosaics from OGRIP are in the NAD83 HARN projection. The default GDAL projection to WGS84 is null, so keep this in mind, especially if you want to maintian high accuracy for the web map tiles. For most of the examples below, Esri tools were used to transform the data from NAD83 HARN Ohio to Web Mercator, due to not being able to replicate the NAD83 to HARN Ohio Esri transformation using open source tools.

*A custom `proj` string can be used go from NAD83 to WGS84, ([getbounds.com/blog/rtk-to-wgs84/](https://www.getbounds.com/blog/rtk-to-wgs84/)).

---

### Pre-processing

**Raw TIFF Files (ArcGIS Pro)**

1. Created a Mosaic of TIFF files
2. Projected Raster to EPSG:3735 LZW TIFF
3. Projected Raster to EPSG:3857 JPG YCbCR TIFF

**OGRIP MrSID Files (QGIS)**

1. Copy Raster to EPSG:3857 JPG YCbCR
  - (NULL Transformation)

---


### Overview

- Overview of raster tiles
- Discussion of **Why?**
- Create tiles with GDAL
- Running in **Production?**
- Introduction to mbtiles
- Create mbtiles with QGIS
- Serve with mbtileserver
 - pre-built windows exe file

---

### The world is (not) a square.

![zoom-levels](zoom-levels.png)

256x256 or 512x512 pixels

---

### Why not Commerical (Satellite) Imagery?

- No control over Projections/Transformations
- Commercial Imagery is Outdated
- Cannot be supplemented with UAV Mosaics
- Low Resolution [(15cm Sat Coming Soon!)](https://www.geospatialworld.net/news/radar-satellite-startup-umbra-plans-to-capture-imagery-with-15-cm-resolution/)

---

### Bing Maps (~2016)

![](img/medcenter-bing.png)

---

### Google Maps (~2018)

![](img/medcenter-google.png)

---

### Esri/Mapbox (Maxar ~2019)

![](img/medcenter-mapbox.png)

---

### Local 2020 Aerial

![](img/medcenter-local.png)

---

### Additional Benefits

- Supplement the tiles with newer imagery
- Any image can be tiled, not just ortho imagery
- Raw Tiles can be hosted anywhere
- Tools are free and open source

---

### Warning

> Live Coding Ahead!!

---

### Let's Explore Some Data

<pre><code data-trim data-noescape data-python>gdalinfo Franklin_rgb_100x.sid
</code></pre>

---

### Key Components

- NODATA Value
- Projection
- Compression
- Pyramids

---

### Raster Tiling Tools

- ArcGIS Image Cache
- QGIS Generate xyz tiles (mbtiles)
- gdal2tiles

---

### Hosting Options

- ArcGIS Image Cache 
  - ArcGIS Server/AGOL
- mbtiles file
  - mbtileserver
- XYZ Folder Tree
  - **Any web host**

---


[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles x 2
Optionally convert the directory of png image tiles to the webp format.

---

## Get the Data

---

transparency

---

web preview

---

multi-threaded

---

output format

- png
- jpg
- webp

---

QGIS Built-in Converter


Load the raster into QGIS
Change the zoomed in sampling to Average and any other settings under properties
Export to raster tiles using the processing tool Generate XYZ Tiles

---

Use the latest gdal2tiles.py python script downloaded from the gdal GitHub site to cut the tif into a folder of high resolution raster tiles for use in web mapping. There are similar scripts that will output to mbtiles, output to geopackage, or write to JPG files. This script was originally written by the developer of MapTiler. The default for this updated script is to use all the availabel cpu cores, so be careful when running it. Set the --processes to something you can live with, such as half the available cores. A maximum zoom limit of 20 seems to be a good limit, which is about street level, however if you want to use them in AGOL you will need to go to zoom 21 as AGOL does not overzoom tiles.

---

```Python
python.exe gdal2tiles.py -xyz -v sourceFile.tif outputFolder
```

```Python
python gdal2tiles.py -e -z 0-21 -v --xyz --processes=ALL original_tiff_file destination_directory
```

```
--tilesize=512
```

## Hosting your Tiles

- https://github.com/maptiler/tileserver-php
- https://github.com/consbio/mbtileserver

---

#### References

- https://www.researchgate.net/publication/321064657_Web_mercator_and_raster_tile_maps_two_cornerstones_of_online_map_service_providers
- https://blog.mastermaps.com/2008/03/generating-map-tiles-with-gdal2tiles.html
- http://build-failed.blogspot.com/2012/11/zoomable-image-with-leaflet.html
- https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/
- https://wiki.openstreetmap.org/wiki/TMS
- https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/
- https://github.com/ecometrica/gdal2mbtiles
- http://emapr.ceoas.oregonstate.edu/pages/education/how_to/how_to_tws.html
- https://developers.google.com/kml/articles/raster
- http://www.perrygeo.com/lazy-raster-processing-with-gdal-vrts.html