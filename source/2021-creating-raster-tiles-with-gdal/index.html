---
layout: slides-reveal
title: Raster Tiles with QGIS & GDAL
theme: therepublic
markdown: true
date: 2021-05-11
tags: slides
transition: none
css: >-
  .reveal .slide-background {
    background-color: #121212;

  }
  h1 {
    text-align: inherit;
  }
  .reveal .slides {
    color: #fff;
    max-height: calc(100% - 6rem);
    overflow: hidden;
    text-align: left;
  }

  *, .reveal {
    font-family: "Inconsolata", monospace;
  }
  
  .reveal h1, .reveal h2, .reveal h3, .reveal h4 {
    color: #fff;
    font-family: "Kanit", monospace;
    font-weight: 600;
    text-transform: none
  }

  .reveal code, .reveal table {
    font-size: smaller;
    margin: 0;
  }

  .reveal blockquote {
  /*    font-family: "Galaxy";*/
  /*background: hsl(349deg 86% 95%);*/
    border-radius: 5px;
    padding: 1.5rem;
    width: 90%;
    text-align: center;
    font-style: normal;
    font-size: 1.2em;

  }

  .reveal blockquote, .controls-arrow {
    color: crimson;
    color: #FFF92F
  }

  .reveal em {
    color: #FFF92F;
    font-style: normal
  }

  .reveal strong {
    color: crimson;
  }
  /*red - rgb(187,36,50)
  blue/[urple - rgb(35,34,131)
  light blue - rgb(212,224,248)
  darkgreen - rgb(14,75,42)
  yellow - FFF92F*/

  .reveal section img, .reveal video, .reveal iframe {
    margin: 0 auto;
    max-width: 85%;
    max-height: 85%;
    text-align: center;
  }
  .reveal code:not(.hljs) {
    color: #121212;
    filter: invert(1);
  }
  .reveal pre {
    width: 100%;
  }
center: false
highlight: monokai.css
---

## DIY Raster Tiles with QGIS & GDAL

*Using open source tools to generate orthomosaics and web map tiles from aerial imagery.*

<br>
Malcolm Meyer

Ohio GIS Conference 2021

---

# About Me

- BA in Sociology, MA in International Affairs
- 10 Years in the Geospatial Sector
- ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è
- ‚òï Coffee, üåæ Gardening, üé∏ Music 
- ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è

---

![floppy disc showing write protext notch](img/disc.jpg)

_note:
My inital exposure to open source came from two places, the Agricutlure and the seed savers movement and open pollinated seeds and the deisre to own as many commodore 64 games as possible.

---

## *High Resolution Orthoimagery is one of the foundations of a Modern GIS.*

_note:
serves as the basis for all our desktop and web maps

---

### Why not Commerical *(Satellite)* Imagery?

- Commercial Imagery is Outdated
- No control over Projections/Transformations
- No control of the tile server
- Low Resolution
  - [15cm Native Imagery - Umbra](https://www.geospatialworld.net/news/radar-satellite-startup-umbra-plans-to-capture-imagery-with-15-cm-resolution/)
  - [15cm Maxar Upscaled Imagery](https://blog.maxar.com/earth-intelligence/2020/introducing-15-cm-hd-the-highest-clarity-from-commercial-satellite-imagery)


_note:
I am going to show three screenshots taken from three map imagery providers, all in the same day earlier this year and then we can compare these with our locally sourced imagery

---

### Bing Maps (~2016)

![](img/medcenter-bing.png)

---

### Google Maps (~2018)

![](img/medcenter-google.png)

---

### Esri/Mapbox (Maxar ~2019)

![](img/medcenter-mapbox.png)

---

### *Local 2020 Aerial*

![](img/medcenter-local.png)

---

## Why FOSS4G *DIY* Tiles

- No need to tie up a licensed/production machine for image processing
- You get to learn more about how web maps work
- No need for commercial software to create or publish raster tiles to the web
- Full control of the mosaic to tile pipeline
- You want to plan a mission to Mars

_note: 
We know we want to use our own imagery, but why use open source tools for image processing?
in some instances the Esri solutions were faster to run, in others the open source solution...but for the main orthomosaic COG, gdal_translate was several days faster and created an output tiff 

---

## Even More Reasons

![arcgis cache error](img/cache_error.png)

---

## Simple Deployment

### *The output can be deployed on any static web host or CDN**

<br>

*In some instances it will be advantageous to use a single mbtiles file (sqlite db) instead of a directory of tiles.

---

## Tools are *Open Source*

[![alt=image of mars](img/mmgis-snapshot.png)](https://mars.nasa.gov/maps/)

---

## *Pipeline*

  - 1 Raw TIFF
  - 2 Mosaic
  - 3 Cloud Optimized GeoTIFF
  - 4 Raster Tiles

---

## Cloud Optimized GeoTIFF

> A regular GeoTIFF file, aimed at being hosted on a HTTP file server, with an internal organization that enables more efficient workflows on the cloud.

---

## Raster Tile Basics

*Maps are usually in Web Mercator EPSG:3857*

![](img/zoom-levels.png)

Each zoom level is a directory, each column is a subdirectory, and each tile is an image.

---

#### Carta do Mundo de Mercator (1569)

[![alt=Carta do Mundo de Mercator 1569](img/1024px-Mercator_1569.png)]((https://en.wikipedia.org/wiki/Mercator_1569_world_map#/media/File:Mercator_1569.png))

---

## The 'Mercator' Projection

*Firstly, to spread on a plane the surface of the sphere in such a way that the positions of places shall correspond on all sides with each other, both in so far as true direction and distance are concerned and as correct longitudes and latitudes...*

---

## On Cartography

*...the limitations of ancient geography be not unknown and that the honour which is due to past centuries be given to them.*

~ Gerardus Mercator, 1569

---

## Mercator Distortions

![alt=map showing true size of continents](img/mercator-true-size.png)

[True Size](https://thetruesize.com/)

---

### Note on Transformations

*NAD83 < > WGS84*

EPSG.io ([skip ahead](./#/18))

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +datum=NAD83 +to_meter=0.3048006096012192 +no_defs 
  </code>
</pre>

SpatialReference.org

<pre>
  <code>+proj=lcc +lat_1=40.03333333333333 +lat_2=38.73333333333333 +lat_0=38 +lon_0=-82.5 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=us-ft +no_defs
  </code>
</pre>

---

## On Transformations

> It‚Äôs the classic problem of spurious precision...The problem we‚Äôre trying to solve is topological accuracy, not absolute accuracy. ~ Utah Geospatial Resource Center

---

## Image Processing Tools

### **GDAL**

 - gdalinfo
 - gdalbuildvrt
 - gdal_translate
 - gdal_warp

---

## Raster Tiling Tools

- ArcGIS Image Cache
- gdal2tiles
- QGIS Generate xyz tiles (mbtiles)
- gdal_translate (mbtiles)

---

## Hosting Options

- COG
  - Terracotta, Titiler (Python)
- ArcGIS Image Cache 
  - ArcGIS Server/AGOL
- XYZ Folder Tree
  - **Any web host**
- mbtiles file
  - mbtileserver (Go), wmts-server (NodeJS), many more...

---

### A Note on File Size (z21)

|Source|Files|Format|Size|
|-|-:|-|-:|
|Raw Tiff|39,985|TIFF|1150 GB|
|*Esri Export*|4|TIFF/LERC|620 GB|
|gdal_translate COG|2|TIFF/JPG|82 GB|
|ArcGIS Cache|1,316|PNG,JPG|101 GB|
|Raster Tiles|11,511,665|PNG|851 GB|
|Raster Tiles|11,511,665|**WEBP**|200 GB|
|Raster Tiles|11,511,665|JPG|120 GB|
|mbtiles|1|SQLITE/JPG|115 GB|

---

## Custom WMTS Tile Server

### WMTS Endpoint & <strong style="text-shadow: 2px 2px #FFF">OverZoom</strong>

> Take a tile at zoom level 20, resize it, slice it up and serve it back to the client!

---
## OverZoom Example

<span style="float:left;display:flex">

  ![sliced up image](img/z20.png)

  ![sliced up image](img/z21.png)
  
  ![sliced up image](img/z22.png)

</span>

---

## Mobile Viewing of MBTiles

- Input/Mergin
- MapTiler
- SWMaps
- QField

---


# BREAK

---

## Let's Get <strong>Coding</strong>

*For those wanting to follow along.*

- Have QGIS ^3.x installed and working
- Have gdal installed and working
  - Open OSGeo4W Shell
  - Type ``gdalinfo --version``
  - Return ~ ``GDAL 3.3.1, released 2021/06/28``
- Obtain a copy of the sample rasters

---

## The Process

1.Explore raster metadata with gdalinfo.

2.Verify the accuracy of the data in QGIS with GPS ground control points.

2.Create a Mosaic with `gdalbuildvrt` (force NAD83 SP South).

3.Create the COG with `gdal_translate`.

4.Examine the output in QGIS.

5.Create another VRT in WebMercator.

6.Generate Raster Tiles with `gdal2tiles`, `gdal_translate`, and QGIS.

7.Serve the raster tiles with `wmts-server`.

8.View the mbtiles file on mobile with ?.

---

gdal-info

XYZ map tiles what are they brief explanation

![](/images/zoom-levels.png)

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

---

## *Null Transformation*

<pre>
  <code>
    +datum=NAD83 | +towgs84=0,0,0,0,0,0,0
  </code>
</pre>

#### **Esri ITRF00 (Default NAD83 <> WGS84)**

<pre>
  <code>
    0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062
  </code>
</pre>

[proj definitions](#/12)
---

## Proj4 String

Replacement for the default NAD83 projection definition in GDAL.

<pre>
  <code>
    +proj=lcc +lat_0=38 +lon_0=-82.5 +lat_1=40.0333333333333 +lat_2=38.73333333333 \
    +x_0=600000 +y_0=0 +ellps=GRS80 \
    +towgs84=-0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062 \
    +units=us-ft +no_defs
  </code>
</pre>

---

`run gdalwarp project into 3857 - this results in a crisper image compared to virtually transforming into 4326`

```bash

gdalwarp -t_srs EPSG:3857 -s_srs "+proj=lcc +lat_0=38 +lon_0=-82.5 +lat_1=40.0333333333333 +lat_2=38.7333333333333 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=-0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062 +units=us-ft +no_defs" -r average -multi -srcnodata 255 -of VRT input_file.tif output_file.vrt

gdalwarp OSIP_2018_3IN_COG.tif OSIP_2018_3IN_COG_3857.vrt ^
-t_srs EPSG:3857 ^
-s_srs "+proj=lcc +lat_0=38 +lon_0=-82.5 +lat_1=40.0333333333333 +lat_2=38.7333333333333 +x_0=600000 +y_0=0 +ellps=GRS80 +towgs84=-0.9956,1.9013,0.5215,0.025915,0.009246,0.011599,-0.00062 +units=us-ft +no_defs" ^
-of VRT ^
-dstalpha ^
-overwrite

```

.vrt is a supported Raster format type for Esri applications. See https://pro.arcgis.com/en/pro-app/latest/help/data/imagery/supported-raster-dataset-file-formats.htm

*This resulting virtual raster can be used directly in ArcGIS Pro or QGIS to create a Map Server Tile Cache or mbtiles cache instead of having to first export the original raster into Web Mercator.*

---

## **MrSID**

### GDAL MrSID Driver

> This Extensis‚Äô decoding software development kit is not free software, you should contact Extensis to obtain it.

*If you have Arc* installed you will likely have this driver available in GDAL.*

---

### Let's Explore Some Data

<pre><code data-trim data-noescape data-python>gdalinfo Franklin_rgb_100x.sid
</code></pre>

---

### Key Components

- NODATA Value
- Projection
- Compression
- Pyramids

---

[See Leaflet Example](https://leafletjs.com/examples/zoom-levels/)

Colorizing in QGIS
NODATA

Clip and project the raster
Cut the raster into png XYZ image tiles
Convert the png images to webp
Directly copy the files to the server via USB
Each additional zoom inceases the total tiles by previous zoom number of tiles x 2
Optionally convert the directory of png image tiles to the webp format.

---

## Get the Data

---

transparency

---

web preview

---

multi-threaded

---

output format

- png
- jpg
- webp

---

QGIS Built-in Converter


Load the raster into QGIS
Change the zoomed in sampling to Average and any other settings under properties
Export to raster tiles using the processing tool Generate XYZ Tiles

---

Use the latest gdal2tiles.py python script downloaded from the gdal GitHub site to cut the tif into a folder of high resolution raster tiles for use in web mapping. There are similar scripts that will output to mbtiles, output to geopackage, or write to JPG files. This script was originally written by the developer of MapTiler. The default for this updated script is to use all the availabel cpu cores, so be careful when running it. Set the --processes to something you can live with, such as half the available cores. A maximum zoom limit of 20 seems to be a good limit, which is about street level, however if you want to use them in AGOL you will need to go to zoom 21 as AGOL does not overzoom tiles.

---

```Python
python.exe gdal2tiles.py -xyz -v sourceFile.tif outputFolder
```

```Python
python gdal2tiles.py -e -z 0-21 -v --xyz --processes=ALL original_tiff_file destination_directory
```

```
--tilesize=512
```

## Hosting your Tiles

- https://github.com/maptiler/tileserver-php
- https://github.com/consbio/mbtileserver

---

### Merging & Updating mbtiles

Using DB Browser (SQLite), run the following SQL command with the destination mbtiles file open.

<pre><code>PRAGMA journal_mode=PERSIST;
PRAGMA page_size=80000;
PRAGMA synchronous=OFF;
ATTACH DATABASE 'c:/path/to/updated_file.mbtiles' AS source;
REPLACE INTO tiles SELECT * FROM source.tiles;
</code></pre>

---


## Raster Tile Servers

Copying millions of small files can take a very long time, however deployment is as simple as pointing a web server to a folder.

Using an mbtiles database and server has a few key advantageous

* The entire file cache is stored in a single file vs millions of small files.
* Complete control of the image server, allowing things like overzoom to be handled by the server instead of the client


### mbtileserver

- mbtileserver
 - Written in GO, deployed via a windows exe file
- wmts-server
 - NodeJS server with WMTS endoints and 3x overzoom

---

```
gdalinfo raster.tif
```
gdalsrsinfo -o proj4 g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid
gdalinfo g:\data\imagery\fairfield\2020\OHFAIR20-SID-3INCH.sid

[https://gdal.org/programs/gdalsrsinfo.html](https://gdal.org/programs/gdalsrsinfo.html)
[https://gdal.org/programs/gdalinfo.html](https://gdal.org/programs/gdalinfo.html)
---


#### References

- https://www.researchgate.net/publication/321064657_Web_mercator_and_raster_tile_maps_two_cornerstones_of_online_map_service_providers
- https://blog.mastermaps.com/2008/03/generating-map-tiles-with-gdal2tiles.html
- http://build-failed.blogspot.com/2012/11/zoomable-image-with-leaflet.html
- https://alastaira.wordpress.com/2011/07/11/maptiler-gdal2tiles-and-raster-resampling/
- https://wiki.openstreetmap.org/wiki/TMS
- https://pvanb.wordpress.com/2017/03/06/raster2mbtiles/
- https://github.com/ecometrica/gdal2mbtiles
- http://emapr.ceoas.oregonstate.edu/pages/education/how_to/how_to_tws.html
- https://developers.google.com/kml/articles/raster
- http://www.perrygeo.com/lazy-raster-processing-with-gdal-vrts.html
- https://jeromegagnonvoyer.wordpress.com/2015/08/06/merging-multiple-mbtiles-together/

"It essentially relies upon the GTiff ‚Äì GeoTIFF File Format driver with the COPY_SRC_OVERVIEWS=YES creation option, but automatically does the needed preprocessing stages (reprojection if asked and creation of overviews on imagery and/or mask) if not already done, and also takes care of morphing the input dataset into the expected form when using some compression types (for example a RGBA dataset will be transparently converted to a RGB+mask dataset when selecting JPEG compression)" ~ [GDAL](https://gdal.org/drivers/raster/cog.html)

QGIS gdal2tiles - artifacts on drawing